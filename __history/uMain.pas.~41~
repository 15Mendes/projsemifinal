unit uMain;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants,
  System.Classes, Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs, 
  Vcl.StdCtrls, Vcl.ExtCtrls, uEstudantes, uData;

type
  TFormAlunos = class(TForm)
    procedure FormCreate(Sender: TObject);
  protected
    nome:String;
    codigo: integer;

    Panel1: TPanel;
    Label1: TLabel;
    Label2: TLabel;
    Button1: TButton;
    Panel2: TPanel;
    bListar: TButton;
    BEditar: TButton;
    BExcluir: TButton;
    Edit1: TEdit;
    Edit2: TEdit;
    ListBox1: TListBox;
    bProximoForm: TButton;
    procedure Button1Click(Sender: TObject);
    procedure bListarClick(Sender: TObject);
    procedure ListBox1Click(Sender: TObject);
    procedure Edit1KeyPress(Sender: TObject; var Key: Char);
    procedure Edit2KeyPress(Sender: TObject; var Key: Char);
    procedure TListBox1Click(Sender: TObject);
    procedure BEditarClick(Sender: TObject);
    procedure BExcluirClick(Sender: TObject);
    procedure bProximoFormClick(Sender: TObject);


    { Private declarations }
  public
    Function SalvarListBox(anome: string; acodigo: integer): boolean;
  end;

var
  FormAlunos: TFormAlunos;

implementation
{$R *.dfm}


// faz o pré edit
procedure TFormAlunos.TListBox1Click(Sender: TObject);
begin
  var
    partes: TArray<string>;
  if ListBox1.ItemIndex >= 0 then
  begin
    partes := ListBox1.Items[ListBox1.ItemIndex].Split(['  |  ']);
    if Length(partes) = 2 then
      begin
        Edit1.Text := partes[0];
        Edit2.Text := partes[1];
      end;
  end;
end;

// adiciona na list box
function TFormAlunos.SalvarListBox(anome: string; acodigo: integer): boolean;
var
  i: integer;
  texto: string;
begin
  texto := acodigo.ToString;
  for i := 0 to ListBox1.Items.Count - 1 do
    begin
      if ListBox1.Items[i].Contains(texto) then
        begin
          result := false;
          ShowMessage('Código já esta em uso, escolha outro!');
          Edit2.SetFocus;
          exit;
        end;
    end;
  ListBox1.Items.Add(anome + '  |  ' + acodigo.ToString);
  result := true;
end;

// edita a info da lista
procedure TFormAlunos.BEditarClick(Sender: TObject);
var
  posicao: integer;
  begin
    posicao := ListBox1.ItemIndex;

    if posicao < 0 then begin
      ShowMessage('Selecione um item para editar.');
      exit;
    end;

    ListBox1.Items[posicao] := Edit1.Text +'  |  '+ Edit2.Text;

    Edit1.Clear;
    Edit2.Clear;
    Edit1.SetFocus;
  end;

// aparece a list box
procedure TFormAlunos.bListarClick(Sender: TObject);
var
  anome: string;
  acodigo: integer;

    begin
      ListBox1Click(self);
    end;

// funções do botão salvar
procedure TFormAlunos.Button1Click(Sender: TObject);
var
  anome: string;
  acodigo: integer;
  begin
    anome := Edit1.Text;
    acodigo := StrToInt(Edit2.Text);
    ListBox1.Sorted := true;

    if SalvarListBox(anome, acodigo) then
      begin
        ShowMessage('Salvo com sucesso!');
        Edit1.Clear;
        Edit2.Clear;
        Edit1.SetFocus;
      end;
  end;


// tecla do enter pt.I
procedure TFormAlunos.Edit1KeyPress(Sender: TObject; var Key: Char);
  begin
    if Key = #13 then
      begin
        Key := #0;
        SelectNext(ActiveControl, true, true);
      end;
  end;

// tecla do enter pt.II
procedure TFormAlunos.Edit2KeyPress(Sender: TObject; var Key: Char);
  begin
    if Key = #13 then
      begin
        Key := #0;
        SelectNext(ActiveControl, true, true);
      end;
  end;

procedure TFormAlunos.FormCreate(Sender: TObject);
var codigo:Integer;
    nome:String;
begin

// Update/Insert/Delete
//  uData.Dados.Connection.Connected:=True;
//  uData.Dados.Query.SQL.Text:='UPDATE Alunos SET nome = ''Samuel'' WHERE id = 1';
//  uData.Dados.Query.ExecSQL;

// Select
//  uData.Dados.Connection.Connected:=True;
//  uData.Dados.Query.SQL.Text:='SELECT * FROM Alunos WHERE id=1';
//  uData.Dados.Query.Active:=True;
//  uData.Dados.Query.Open(uData.Dados.Query.SQL.Text);
//  codigo:=uData.Dados.Query.FieldByName('id').AsInteger;
//  nome:=uData.Dados.Query.FieldByName('nome').AsString;
//  uData.Dados.Query.Close;
end;

// Aparece a listbox dos alunos
procedure TFormAlunos.ListBox1Click(Sender: TObject);
  begin
    ListBox1.Visible := true;
  end;


//Exclui a informação da ListBox
procedure TFormAlunos.BExcluirClick(Sender: TObject);
  var
  posicao: integer;
  begin
    posicao := ListBox1.ItemIndex;

    if posicao < 0 then
      begin
        ShowMessage('Selecione um item para excluir.');
        Exit;
      end;

    ListBox1.Items.Delete(posicao);

    Edit1.Clear;
    Edit2.Clear;
    Edit1.SetFocus;
  end;


//Vai pro próximo form
procedure TFormAlunos.bProximoFormClick(Sender: TObject);
var
 ProxForm: TForm2;
  begin
    Hide; 
    ProxForm := TForm2.Create(Self); // vai pro Form2
      try
        ProxForm.ShowModal; 
      finally
        ProxForm.Free;
      end;
  end;
end.
